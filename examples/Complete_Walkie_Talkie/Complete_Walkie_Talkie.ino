#include <Arduino.h>\n#include \"DMR828S.h\"\n\n// DMR828S instance using Serial2\nDMR828S dmr(Serial2);\n\n// Walkie-talkie state\nstruct WalkieTalkieState {\n    uint8_t currentChannel = 1;\n    uint8_t volume = 5;\n    uint32_t myRadioID = 0x000001;\n    bool isTransmitting = false;\n    bool isReceiving = false;\n    String lastSMSFrom = \"\";\n    String lastSMSMessage = \"\";\n} wtState;\n\n// Button and LED pins (adjust as needed)\nconst int PTT_BUTTON_PIN = 4;       // Push-to-talk button\nconst int EMERGENCY_BUTTON_PIN = 5;  // Emergency/SOS button\nconst int CHANNEL_UP_PIN = 6;       // Channel up button\nconst int CHANNEL_DOWN_PIN = 7;     // Channel down button\nconst int VOLUME_UP_PIN = 8;        // Volume up button\nconst int VOLUME_DOWN_PIN = 9;      // Volume down button\nconst int TX_LED_PIN = 10;          // Transmit indicator LED\nconst int RX_LED_PIN = 11;          // Receive indicator LED\nconst int STATUS_LED_PIN = 2;       // Status LED (built-in)\n\n// Button states\nbool lastPTTState = HIGH;\nbool lastEmergencyState = HIGH;\nbool lastChannelUpState = HIGH;\nbool lastChannelDownState = HIGH;\nbool lastVolumeUpState = HIGH;\nbool lastVolumeDownState = HIGH;\n\n// Timing\nunsigned long lastStatusCheck = 0;\nunsigned long lastRSSICheck = 0;\nunsigned long emergencyPressTime = 0;\nconst unsigned long EMERGENCY_HOLD_TIME = 3000; // Hold for 3 seconds for emergency\n\n// Event Callbacks\nvoid onSMSReceived(const DMRSMSMessage &sms) {\n    Serial.println(\"\\nðŸ“© SMS RECEIVED!\");\n    Serial.print(\"From ID: 0x\");\n    Serial.println(sms.sourceID, HEX);\n    Serial.print(\"Type: \");\n    Serial.println(sms.type == 1 ? \"Private\" : \"Group\");\n    Serial.print(\"Message: \");\n    Serial.println(sms.message);\n    \n    wtState.lastSMSFrom = String(sms.sourceID, HEX);\n    wtState.lastSMSMessage = String(sms.message);\n    \n    // Blink status LED to indicate new message\n    for (int i = 0; i < 6; i++) {\n        digitalWrite(STATUS_LED_PIN, HIGH);\n        delay(100);\n        digitalWrite(STATUS_LED_PIN, LOW);\n        delay(100);\n    }\n}\n\nvoid onCallReceived(const DMRCallInfo &callInfo) {\n    Serial.println(\"\\nðŸ“ž INCOMING CALL!\");\n    Serial.print(\"From ID: 0x\");\n    Serial.println(callInfo.contactID, HEX);\n    Serial.print(\"Type: \");\n    switch(callInfo.type) {\n        case CALL_PRIVATE: Serial.println(\"Private Call\"); break;\n        case CALL_GROUP: Serial.println(\"Group Call\"); break;\n        case CALL_ALL: Serial.println(\"All Call\"); break;\n        default: Serial.println(\"Unknown\"); break;\n    }\n    \n    wtState.isReceiving = true;\n    digitalWrite(RX_LED_PIN, HIGH);\n}\n\nvoid onCallEnded() {\n    Serial.println(\"ðŸ“ž Call Ended\");\n    wtState.isReceiving = false;\n    wtState.isTransmitting = false;\n    digitalWrite(RX_LED_PIN, LOW);\n    digitalWrite(TX_LED_PIN, LOW);\n}\n\nvoid onEmergency(uint32_t sourceID) {\n    Serial.println(\"\\nðŸš¨ EMERGENCY ALERT!\");\n    Serial.print(\"From ID: 0x\");\n    Serial.println(sourceID, HEX);\n    \n    // Flash all LEDs for emergency\n    for (int i = 0; i < 10; i++) {\n        digitalWrite(STATUS_LED_PIN, HIGH);\n        digitalWrite(TX_LED_PIN, HIGH);\n        digitalWrite(RX_LED_PIN, HIGH);\n        delay(200);\n        digitalWrite(STATUS_LED_PIN, LOW);\n        digitalWrite(TX_LED_PIN, LOW);\n        digitalWrite(RX_LED_PIN, LOW);\n        delay(200);\n    }\n}\n\nvoid setup() {\n    Serial.begin(115200);\n    Serial.println(\"ðŸŽ™ï¸ DMR828S Walkie-Talkie Demo Starting...\");\n    Serial.println(\"==========================================\");\n    \n    // Initialize pins\n    pinMode(PTT_BUTTON_PIN, INPUT_PULLUP);\n    pinMode(EMERGENCY_BUTTON_PIN, INPUT_PULLUP);\n    pinMode(CHANNEL_UP_PIN, INPUT_PULLUP);\n    pinMode(CHANNEL_DOWN_PIN, INPUT_PULLUP);\n    pinMode(VOLUME_UP_PIN, INPUT_PULLUP);\n    pinMode(VOLUME_DOWN_PIN, INPUT_PULLUP);\n    \n    pinMode(TX_LED_PIN, OUTPUT);\n    pinMode(RX_LED_PIN, OUTPUT);\n    pinMode(STATUS_LED_PIN, OUTPUT);\n    \n    // Initialize all LEDs off\n    digitalWrite(TX_LED_PIN, LOW);\n    digitalWrite(RX_LED_PIN, LOW);\n    digitalWrite(STATUS_LED_PIN, LOW);\n    \n    // Initialize DMR module\n    Serial2.begin(57600, SERIAL_8N1, 16, 17); // RX2=GPIO16, TX2=GPIO17\n    dmr.begin(57600);\n    dmr.enableDebug(true);\n    dmr.enableChecksum(false);\n    \n    // Set event callbacks\n    dmr.setSMSReceivedCallback(onSMSReceived);\n    dmr.setCallReceivedCallback(onCallReceived);\n    dmr.setCallEndedCallback(onCallEnded);\n    dmr.setEmergencyCallback(onEmergency);\n    \n    Serial.println(\"ðŸ”§ Initializing walkie-talkie...\");\n    \n    // Initial configuration\n    delay(2000); // Wait for module to boot\n    \n    if (dmr.setRadioID(wtState.myRadioID)) {\n        Serial.print(\"âœ… Radio ID set to: 0x\");\n        Serial.println(wtState.myRadioID, HEX);\n    }\n    \n    if (dmr.setChannel(wtState.currentChannel)) {\n        Serial.print(\"âœ… Channel set to: \");\n        Serial.println(wtState.currentChannel);\n    }\n    \n    if (dmr.setVolume(wtState.volume)) {\n        Serial.print(\"âœ… Volume set to: \");\n        Serial.println(wtState.volume);\n    }\n    \n    // Set other parameters\n    dmr.setColorCode(1);\n    dmr.setTimeSlot(1);\n    dmr.setTXPower(3); // Max power\n    dmr.setMicGain(8);\n    \n    Serial.println(\"\\nðŸŽ™ï¸ Walkie-Talkie Ready!\");\n    Serial.println(\"Controls:\");\n    Serial.println(\"- GPIO4: PTT (Push-to-Talk)\");\n    Serial.println(\"- GPIO5: Emergency (Hold 3s)\");\n    Serial.println(\"- GPIO6/7: Channel Up/Down\");\n    Serial.println(\"- GPIO8/9: Volume Up/Down\");\n    Serial.println(\"\\nSerial Commands:\");\n    Serial.println(\"- 'sms <id> <message>' - Send SMS\");\n    Serial.println(\"- 'call <id>' - Make private call\");\n    Serial.println(\"- 'group <id>' - Make group call\");\n    Serial.println(\"- 'status' - Show status\");\n    Serial.println(\"- 'info' - Show device info\");\n    Serial.println();\n    \n    digitalWrite(STATUS_LED_PIN, HIGH); // Ready indicator\n}\n\nvoid loop() {\n    // Handle DMR events\n    dmr.update();\n    \n    // Handle button inputs\n    handleButtons();\n    \n    // Handle serial commands\n    handleSerialCommands();\n    \n    // Periodic status checks\n    handlePeriodicTasks();\n    \n    delay(10);\n}\n\nvoid handleButtons() {\n    // PTT Button\n    bool pttState = digitalRead(PTT_BUTTON_PIN);\n    if (pttState != lastPTTState) {\n        if (pttState == LOW) { // Pressed\n            Serial.println(\"ðŸ“¡ PTT Pressed - Starting transmission\");\n            if (dmr.startCall(CALL_GROUP, 0)) {\n                wtState.isTransmitting = true;\n                digitalWrite(TX_LED_PIN, HIGH);\n            }\n        } else { // Released\n            Serial.println(\"ðŸ“¡ PTT Released - Stopping transmission\");\n            dmr.stopCall();\n            wtState.isTransmitting = false;\n            digitalWrite(TX_LED_PIN, LOW);\n        }\n        lastPTTState = pttState;\n    }\n    \n    // Emergency Button (hold for 3 seconds)\n    bool emergencyState = digitalRead(EMERGENCY_BUTTON_PIN);\n    if (emergencyState != lastEmergencyState) {\n        if (emergencyState == LOW) { // Pressed\n            emergencyPressTime = millis();\n        } else { // Released\n            unsigned long holdTime = millis() - emergencyPressTime;\n            if (holdTime >= EMERGENCY_HOLD_TIME) {\n                Serial.println(\"ðŸš¨ Emergency Alert Sent!\");\n                dmr.sendEmergencyAlarm(0); // Send to all\n            }\n        }\n        lastEmergencyState = emergencyState;\n    }\n    \n    // Channel buttons\n    bool channelUpState = digitalRead(CHANNEL_UP_PIN);\n    if (channelUpState == LOW && lastChannelUpState == HIGH) {\n        wtState.currentChannel++;\n        if (wtState.currentChannel > 16) wtState.currentChannel = 1;\n        if (dmr.setChannel(wtState.currentChannel)) {\n            Serial.print(\"ðŸ“» Channel: \");\n            Serial.println(wtState.currentChannel);\n        }\n    }\n    lastChannelUpState = channelUpState;\n    \n    bool channelDownState = digitalRead(CHANNEL_DOWN_PIN);\n    if (channelDownState == LOW && lastChannelDownState == HIGH) {\n        wtState.currentChannel--;\n        if (wtState.currentChannel < 1) wtState.currentChannel = 16;\n        if (dmr.setChannel(wtState.currentChannel)) {\n            Serial.print(\"ðŸ“» Channel: \");\n            Serial.println(wtState.currentChannel);\n        }\n    }\n    lastChannelDownState = channelDownState;\n    \n    // Volume buttons\n    bool volumeUpState = digitalRead(VOLUME_UP_PIN);\n    if (volumeUpState == LOW && lastVolumeUpState == HIGH) {\n        wtState.volume++;\n        if (wtState.volume > 9) wtState.volume = 9;\n        if (dmr.setVolume(wtState.volume)) {\n            Serial.print(\"ðŸ”Š Volume: \");\n            Serial.println(wtState.volume);\n        }\n    }\n    lastVolumeUpState = volumeUpState;\n    \n    bool volumeDownState = digitalRead(VOLUME_DOWN_PIN);\n    if (volumeDownState == LOW && lastVolumeDownState == HIGH) {\n        wtState.volume--;\n        if (wtState.volume < 1) wtState.volume = 1;\n        if (dmr.setVolume(wtState.volume)) {\n            Serial.print(\"ðŸ”Š Volume: \");\n            Serial.println(wtState.volume);\n        }\n    }\n    lastVolumeDownState = volumeDownState;\n}\n\nvoid handleSerialCommands() {\n    if (Serial.available()) {\n        String command = Serial.readStringUntil('\\n');\n        command.trim();\n        \n        if (command.startsWith(\"sms \")) {\n            // Parse SMS command: \"sms <id> <message>\"\n            int firstSpace = command.indexOf(' ', 4);\n            if (firstSpace > 0) {\n                String idStr = command.substring(4, firstSpace);\n                String message = command.substring(firstSpace + 1);\n                \n                uint32_t targetID = strtoul(idStr.c_str(), NULL, 16);\n                \n                if (dmr.sendSMS(targetID, message.c_str())) {\n                    Serial.print(\"ðŸ“¤ SMS sent to 0x\");\n                    Serial.print(targetID, HEX);\n                    Serial.print(\": \");\n                    Serial.println(message);\n                } else {\n                    Serial.println(\"âŒ Failed to send SMS\");\n                }\n            }\n        }\n        else if (command.startsWith(\"call \")) {\n            String idStr = command.substring(5);\n            uint32_t targetID = strtoul(idStr.c_str(), NULL, 16);\n            \n            if (dmr.startCall(CALL_PRIVATE, targetID)) {\n                Serial.print(\"ðŸ“ž Private call to 0x\");\n                Serial.println(targetID, HEX);\n            }\n        }\n        else if (command.startsWith(\"group \")) {\n            String idStr = command.substring(6);\n            uint32_t targetID = strtoul(idStr.c_str(), NULL, 16);\n            \n            if (dmr.startCall(CALL_GROUP, targetID)) {\n                Serial.print(\"ðŸ“ž Group call to 0x\");\n                Serial.println(targetID, HEX);\n            }\n        }\n        else if (command == \"status\") {\n            showStatus();\n        }\n        else if (command == \"info\") {\n            showDeviceInfo();\n        }\n        else if (command == \"help\") {\n            showHelp();\n        }\n        else {\n            Serial.println(\"â“ Unknown command. Type 'help' for commands.\");\n        }\n    }\n}\n\nvoid handlePeriodicTasks() {\n    // Check module status every 5 seconds\n    if (millis() - lastStatusCheck > 5000) {\n        lastStatusCheck = millis();\n        \n        DMRModuleStatus status = dmr.getModuleStatus();\n        switch (status) {\n            case STATUS_RECEIVING:\n                if (!wtState.isReceiving) {\n                    wtState.isReceiving = true;\n                    digitalWrite(RX_LED_PIN, HIGH);\n                }\n                break;\n            case STATUS_TRANSMITTING:\n                if (!wtState.isTransmitting) {\n                    wtState.isTransmitting = true;\n                    digitalWrite(TX_LED_PIN, HIGH);\n                }\n                break;\n            case STATUS_STANDBY:\n            default:\n                if (wtState.isReceiving || wtState.isTransmitting) {\n                    wtState.isReceiving = false;\n                    wtState.isTransmitting = false;\n                    digitalWrite(RX_LED_PIN, LOW);\n                    digitalWrite(TX_LED_PIN, LOW);\n                }\n                break;\n        }\n    }\n    \n    // Check RSSI every 2 seconds (for display purposes)\n    if (millis() - lastRSSICheck > 2000) {\n        lastRSSICheck = millis();\n        \n        uint8_t rssi = dmr.getRSSI();\n        // You can use RSSI for signal strength display\n        // For this demo, we'll just track it silently\n    }\n}\n\nvoid showStatus() {\n    Serial.println(\"\\nðŸ“Š WALKIE-TALKIE STATUS\");\n    Serial.println(\"========================\");\n    Serial.print(\"Channel: \"); Serial.println(wtState.currentChannel);\n    Serial.print(\"Volume: \"); Serial.println(wtState.volume);\n    Serial.print(\"Radio ID: 0x\"); Serial.println(wtState.myRadioID, HEX);\n    Serial.print(\"RSSI: \"); Serial.println(dmr.getRSSI());\n    \n    DMRModuleStatus status = dmr.getModuleStatus();\n    Serial.print(\"Status: \");\n    switch (status) {\n        case STATUS_RECEIVING: Serial.println(\"Receiving\"); break;\n        case STATUS_TRANSMITTING: Serial.println(\"Transmitting\"); break;\n        case STATUS_STANDBY: Serial.println(\"Standby\"); break;\n        default: Serial.println(\"Unknown\"); break;\n    }\n    \n    if (!wtState.lastSMSMessage.isEmpty()) {\n        Serial.print(\"Last SMS from 0x\"); \n        Serial.print(wtState.lastSMSFrom);\n        Serial.print(\": \");\n        Serial.println(wtState.lastSMSMessage);\n    }\n    Serial.println();\n}\n\nvoid showDeviceInfo() {\n    Serial.println(\"\\nðŸ”§ DEVICE INFORMATION\");\n    Serial.println(\"=====================\");\n    \n    uint32_t radioID = dmr.getRadioID();\n    Serial.print(\"Radio ID: 0x\"); Serial.println(radioID, HEX);\n    \n    String version = dmr.getFirmwareVersion();\n    Serial.print(\"Firmware: \"); Serial.println(version);\n    \n    bool encrypted = dmr.getEncryptionStatus();\n    Serial.print(\"Encryption: \"); Serial.println(encrypted ? \"ON\" : \"OFF\");\n    \n    bool initialized = dmr.getInitializationStatus();\n    Serial.print(\"Initialized: \"); Serial.println(initialized ? \"YES\" : \"NO\");\n    \n    DMRChannelParams params;\n    if (dmr.getCurrentChannelParams(params)) {\n        Serial.println(\"\\nChannel Parameters:\");\n        Serial.print(\"  TX Freq: \"); Serial.print(params.txFreq); Serial.println(\" Hz\");\n        Serial.print(\"  RX Freq: \"); Serial.print(params.rxFreq); Serial.println(\" Hz\");\n        Serial.print(\"  Power: \"); Serial.println(params.power);\n        Serial.print(\"  Bandwidth: \"); Serial.println(params.bandwidth == 0 ? \"12.5K\" : \"25K\");\n        Serial.print(\"  Color Code: \"); Serial.println(params.colorCode);\n        Serial.print(\"  Time Slot: \"); Serial.println(params.timeSlot);\n        Serial.print(\"  Contact ID: 0x\"); Serial.println(params.contactID, HEX);\n    }\n    Serial.println();\n}\n\nvoid showHelp() {\n    Serial.println(\"\\nðŸ“– HELP - Available Commands\");\n    Serial.println(\"=============================\");\n    Serial.println(\"Hardware Controls:\");\n    Serial.println(\"  GPIO4: Push-to-Talk (PTT)\");\n    Serial.println(\"  GPIO5: Emergency (hold 3s)\");\n    Serial.println(\"  GPIO6/7: Channel Up/Down\");\n    Serial.println(\"  GPIO8/9: Volume Up/Down\");\n    Serial.println();\n    Serial.println(\"Serial Commands:\");\n    Serial.println(\"  sms <id> <message>  - Send SMS to hex ID\");\n    Serial.println(\"  call <id>           - Make private call to hex ID\");\n    Serial.println(\"  group <id>          - Make group call to hex ID\");\n    Serial.println(\"  status              - Show current status\");\n    Serial.println(\"  info                - Show device information\");\n    Serial.println(\"  help                - Show this help\");\n    Serial.println();\n    Serial.println(\"Examples:\");\n    Serial.println(\"  sms 123 Hello World\");\n    Serial.println(\"  call 456\");\n    Serial.println(\"  group 1\");\n    Serial.println();\n}"